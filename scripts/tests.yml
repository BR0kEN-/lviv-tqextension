---
- hosts: vagrant
  gather_facts: yes

  vars_files:
    - vars/main.yml
    - vars/testing.yml

  vars:
    browser: firefox
    kill_selenium: False

    selenium:
      source: http://selenium-release.storage.googleapis.com/2.45/selenium-server-standalone-2.45.0.jar
      jar: ~/selenium/selenium.jar

  pre_tasks:
    - name: Check Selenium process ID
      shell: "ps aux | grep '{{ selenium.jar | basename }}' | grep -v grep | awk '{print $2}'"
      delegate_to: localhost
      register: selenium_pid

    - name: Register variable with reports URL
      set_fact:
        reports_url: "{{ site_url }}/{{ build_reports_dir | basename }}"

    - name: Create directory for reports
      sudo: yes
      file:
        path: "{{ build_reports_dir }}"
        mode: 0755
        state: "{{ item }}"
      with_items:
        - absent
        - directory

  tasks:
    - include: tasks/tests.init.yml
      when: selenium_pid.stdout == ""

    - name: Run tests
      sudo: yes
      shell: "cd {{ sync_root }}/tests && ../bin/behat {{ behat_vars | default('') }}"
      ignore_errors: yes

    - name: Create Behat report
      shell: 'if [ -s {{ build_reports_dir }}/behat/index.html ]; then echo "<a href=\"{{ reports_url }}/behat/index.html\" target=\"_blank\">Behat report</a>" >> {{ artifacts_file }}; fi'

  post_tasks:
    - name: Kill Selenium Hub
      # All nodes will be killed automatically.
      shell: "kill {{ selenium_pid.stdout }}"
      delegate_to: localhost
      when: kill_selenium and selenium_pid.stdout != ""
